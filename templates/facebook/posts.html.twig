{% extends "frontOffice/base.html.twig" %}

{% block title %}üì¢ Publications Scientifiques sur l'Agriculture{% endblock %}

{% block stylesheets %}
  <style>
    /* Conteneur principal personnalis√© */
    .container-custom {
      margin-top: 100px;
      margin-bottom: 50px;
    }
    /* Carte de publication avec effet d'ombre et survol */
    .post-card {
      margin-bottom: 20px;
      border: none;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s ease-in-out;
    }
    .post-card:hover {
      transform: translateY(-5px);
    }
    /* Style pour l'image de profil */
    .profile-img {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
    }
    /* Style pour les images du post */
    .post-image {
      width: 100%;
      max-height: 400px;
      border-radius: 5px;
      object-fit: cover;
    }
    /* En-t√™te de carte personnalis√© */
    .card-header-custom {
      background: #f8f9fa;
      border-bottom: 1px solid #e9ecef;
    }
    .card-header-custom h2 {
      margin: 0;
    }
    /* Style de la zone de m√©tadonn√©es */
    .post-meta {
      margin-top: 15px;
    }
    /* Bouton personnalis√© pour Facebook */
    .btn-facebook {
      background-color: #4267B2;
      border: none;
      color: #fff;
    }
    .btn-facebook:hover {
      background-color: #365899;
    }
    /* Grille pour l'affichage des images multiples */
    .post-images .col-12 {
      padding: 0.5rem;
    }
  </style>
{% endblock %}

{% block content %}
<div style="height: 100px;"></div>
  <div class="container container-custom">
    <div class="row justify-content-center">
      <div class="col-md-10">
        <div class="card shadow-lg border-0 rounded-lg overflow-hidden">
          <!-- En-t√™te de la carte -->
          <div class="card-header card-header-custom text-center py-3">
            <h2 class="h4 m-0 fw-bold">üì¢ Publications Scientifiques sur l'Agriculture</h2>
          </div>
          <!-- Corps de la carte -->
          <div class="card-body p-4">
            {% if posts is empty %}
              <p class="text-center">Aucun post trouv√©.</p>
            {% else %}
              {% for post in posts %}
                <div class="card post-card">
                  <div class="row no-gutters">
                    <div class="col-md-2 text-center p-3">
                      <img src="{{ post.author.profile_picture_url }}" alt="{{ post.author.name }}" class="profile-img">
                      <p class="mt-2 fw-bold">{{ post.author.name }}</p>
                    </div>
                    <div class="col-md-10">
                      <div class="card-body">
                        <h5 class="card-title text-muted">üìÖ {{ post.timestamp }}</h5>
                        <p class="card-text">{{ post.message }}</p>
                        
                        {# Affichage structur√© des images du post #}
                        {% if post.image %}
                          <div class="post-images mt-3 row">
                            {% if post.image is iterable %}
                              {% for img in post.image %}
                                <div class="col-12 col-md-6 col-lg-4">
                                  <img src="{{ img }}" alt="Image du post" class="img-fluid post-image">
                                </div>
                              {% endfor %}
                            {% else %}
                              <div class="col-12">
                                <img src="{{ post.image }}" alt="Image du post" class="img-fluid post-image">
                              </div>
                            {% endif %}
                          </div>
                        {% endif %}
                        
                        {# Affichage des vid√©os du post #}
                        {% if post.video %}
                          <div class="mt-3">
                            {% if 'facebook.com' in post.video %}
                              <div class="fb-video" data-href="{{ post.video }}" data-width="500" data-allowfullscreen="true"></div>
                            {% else %}
                              <video controls preload="metadata" playsinline class="img-fluid post-video">
                                <source src="{{ post.video }}" type="video/mp4">
                                <source src="{{ post.video }}" type="video/webm">
                                La vid√©o n'a pu √™tre charg√©e.
                              </video>
                            {% endif %}
                          </div>
                        {% endif %}
                        
                        <div class="post-meta">
                          <span class="badge bg-primary">üëç {{ post.reactions_count }} r√©actions</span>
                          <a href="{{ post.url }}" class="btn btn-facebook btn-sm ms-2" target="_blank">Voir sur Facebook</a>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              {% endfor %}
            {% endif %}
            <!-- Bouton "Voir plus" -->
            <div class="text-center mt-4">
              <button id="load-more" class="btn btn-secondary load-more" {% if cursor is null %}style="display:none"{% endif %}>Voir plus</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Script du SDK Facebook -->
  <script async defer crossorigin="anonymous" src="https://connect.facebook.net/fr_FR/sdk.js#xfbml=1&version=v15.0"></script>
  <!-- Script de chargement dynamique des posts -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      let cursor = "{{ cursor|default('') }}";
      const loadMoreBtn = document.getElementById('load-more');
      const postsContainer = document.querySelector('.card-body');
      
      loadMoreBtn.addEventListener('click', function () {
        if (!cursor) {
          loadMoreBtn.style.display = 'none';
          return;
        }
        fetch(`/facebook/posts/more/${encodeURIComponent(cursor)}`)
          .then(response => response.json())
          .then(data => {
            if (data.posts.length === 0) {
              loadMoreBtn.style.display = 'none';
            } else {
              data.posts.forEach(post => {
                let imageHtml = '';
                if (post.image) {
                  if (Array.isArray(post.image)) {
                    imageHtml += '<div class="post-images mt-3 row">';
                    post.image.forEach(img => {
                      imageHtml += `<div class="col-12 col-md-6 col-lg-4"><img src="${img}" alt="Image du post" class="img-fluid post-image"></div>`;
                    });
                    imageHtml += '</div>';
                  } else {
                    imageHtml = `<div class="post-images mt-3 row"><div class="col-12"><img src="${post.image}" alt="Image du post" class="img-fluid post-image"></div></div>`;
                  }
                }
                
                let videoHtml = '';
                if (post.video) {
                  if (post.video.includes('facebook.com')) {
                    videoHtml = `<div class="mt-3"><div class="fb-video" data-href="${post.video}" data-width="500" data-allowfullscreen="true"></div></div>`;
                  } else {
                    videoHtml = `<div class="mt-3"><video controls preload="metadata" playsinline class="img-fluid post-video">
                                    <source src="${post.video}" type="video/mp4">
                                    <source src="${post.video}" type="video/webm">
                                    La vid√©o n'a pu √™tre charg√©e.
                                  </video></div>`;
                  }
                }
                
                let postHtml = `
                  <div class="card post-card mb-4">
                    <div class="row no-gutters">
                      <div class="col-md-2 text-center p-3">
                        <img src="${post.author.profile_picture_url}" alt="${post.author.name}" class="profile-img">
                        <p class="mt-2 fw-bold">${post.author.name}</p>
                      </div>
                      <div class="col-md-10">
                        <div class="card-body">
                          <h5 class="card-title text-muted">üìÖ ${post.timestamp}</h5>
                          <p class="card-text">${post.message}</p>
                          ${imageHtml}
                          ${videoHtml}
                          <div class="post-meta">
                            <span class="badge bg-primary">üëç ${post.reactions_count} r√©actions</span>
                            <a href="${post.url}" class="btn btn-facebook btn-sm ms-2" target="_blank">Voir sur Facebook</a>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>`;
                postsContainer.insertAdjacentHTML('beforeend', postHtml);
              });
              
              cursor = data.cursor;
              if (!cursor) {
                loadMoreBtn.style.display = 'none';
              }
              
              // Recharge les √©l√©ments pour le SDK Facebook
              if (typeof FB !== 'undefined') {
                FB.XFBML.parse();
              }
            }
          })
          .catch(error => {
            console.error("Erreur lors du chargement des posts :", error);
          });
      });
    });
  </script>
{% endblock %}
